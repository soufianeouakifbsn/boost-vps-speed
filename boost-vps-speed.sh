#!/bin/bash
# سكربت ضبط إعدادات sysctl لتحسين سرعة الأبلود وتحسين الأداء بشكل عام 🚀 (مُعدَّل)

echo "🔧 تطبيق إعدادات متقدمة للشبكة (مُعدَّلة لتحسين الأبلود)..."

# كتابة الإعدادات إلى sysctl.conf
cat > /etc/sysctl.conf <<EOF
# ==== تحسين الشبكة (تركيز على الأبلود والأداء العام) ====

# تخصيص ذاكرة TCP (قيم أعلى قليلاً لتحسين التدفق)
net.core.rmem_default = 2097152
net.core.rmem_max = 67108864
net.core.wmem_default = 2097152
net.core.wmem_max = 67108864

# تخصيص ذاكرة TCP أثناء النقل (قيم أعلى قليلاً لتحسين التدفق)
net.ipv4.tcp_rmem = 4096 87380 67108864
net.ipv4.tcp_wmem = 4096 65536 67108864

# تخصيص حجم قائمة الانتظار للـ TCP (قيمة عالية لتحمل الازدحام المؤقت)
net.core.netdev_max_backlog = 1000000
net.core.somaxconn = 65536

# استخدام TCP Cubic لتحسين الأداء (خوارزمية حديثة وفعالة)
net.ipv4.tcp_congestion_control = cubic
net.ipv4.tcp_mtu_probing = 1
net.ipv4.tcp_no_metrics_save = 1
net.ipv4.tcp_window_scaling = 1

# تفعيل TCP Fast Open لتسريع الاتصال (مفيد للاتصالات المتكررة)
net.ipv4.tcp_fastopen = 3

# تخصيص المجال المحلي للمنافذ (نطاق واسع لتجنب مشاكل استنفاد المنافذ)
net.ipv4.ip_local_port_range = 1024 65535

# تقليل وقت الانتظار في TCP (قيم متحفظة لتحسين الاستجابة دون مخاطر)
net.ipv4.tcp_fin_timeout = 15
net.ipv4.tcp_tw_reuse = 1

# تعطيل إعادة التوجيه في الشبكة (إجراء أمني قياسي)
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.all.send_redirects = 0

# تحسين الأداء في TCP (تفعيل لتكييف حجم النافذة)
net.ipv4.tcp_moderate_rcvbuf = 1
net.ipv4.tcp_timestamps = 0

# زيادة الأداء في إرسال واستقبال الحزم (تم تعديل القيم لتكون أكثر توازناً)
# هذه القيم تم تضمينها بالفعل في الأعلى
# net.ipv4.tcp_rmem = 4096 87380 134217728
# net.ipv4.tcp_wmem = 4096 65536 134217728

# تحسين استقرار الاتصال (تمكين التوجيه إذا كان هذا الخادم يقوم بدور الموجه)
# إذا كان هذا مجرد جهاز عادي، فقد لا تحتاج إلى هذا.
# net.ipv4.ip_forward = 0

# ==== تحسين النظام ====

# زيادة حد الملفات المفتوحة (قيمة عالية لدعم التطبيقات التي تتعامل مع عدد كبير من الاتصالات)
fs.file-max = 2097152

# تخصيص الحد الأقصى لعدد العمليات (قيمة عالية لمراقبة عدد كبير من الملفات)
fs.inotify.max_user_watches = 524288

# تخصيص الذاكرة الافتراضية (قيمة أقل لزيادة استخدام الذاكرة الحقيقية وتحسين الأداء، خاصة للأبلود)
vm.swappiness = 5
EOF

# تطبيق التعديلات
sysctl -p

echo "✅ تم تطبيق إعدادات sysctl بنجاح (مُعدَّلة)!"

# ضبط حدود الملفات المفتوحة (ulimit)
echo "🔧 رفع حدود الملفات المفتوحة..."

ulimit -n 1048576

# إضافة للملفات الدائمة
cat >> /etc/security/limits.conf <<EOF

# ==== رفع حدود الملفات المفتوحة ====
* soft nofile 1048576
* hard nofile 1048576
EOF

echo "✅ تم ضبط limits.conf بنجاح!"

# نصيحة
echo ""
echo "🚀 تم إجراء بعض التعديلات لتركيز الأداء على سرعة الأبلود وتحسين الاستجابة العامة."
echo "💡 من المستحسن إعادة تشغيل السيرفر لتطبيق جميع التغييرات بكفاءة."
echo "لإعادة تشغيل السيرفر الآن اكتب: sudo reboot"
